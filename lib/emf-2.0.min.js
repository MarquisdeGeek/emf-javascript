var emf={};emf.audio=function(e,t){let n,r,i,s,o,a=44100,u=8,c=!1,f=[],l=[],d=1;function m(){i=new Array,h(),v()}function g(){return"suspended"===n.state}function p(){if(!c)return;(s=n.createScriptProcessor(8192,1,1)).onaudioprocess=function(e){let t=e.outputBuffer.getChannelData(0);r?t.map(e=>0):function(e){for(var t=0,n=0;n<e.length;n++){for(var r=0,s=0;s<u&&t<i.length;s++)r+=i[t++];r/=u,r*=.7,e[n]=r}t>=i.Length?i=new Array:i.splice(0,t)}(t)};let e=n.createBufferSource();e.connect(s),s.connect(n.destination),e.start()}function h(){var e;f.forEach(t=>{(e=t)&&e.id&&sgx.audio.Engine.get().stopSound(e.id)})}function b(e){let t={id:d,idx:l.length,oscillator:n.createOscillator()};return l.push(t),t.oscillator.frequency.setValueAtTime(e,n.currentTime),t.oscillator.connect(n.destination),t.oscillator.type="triangle",t.oscillator.start(),++d,t.id}function y(e){let t=l.filter(t=>t.id==e);t.length&&(t[0].oscillator.stop(),t[0].oscillator=void 0,delete l[t[0].idx])}function v(){l.forEach(e=>{y(e)})}return function(){let e=window.AudioContext||window.webkitAudioContext;n=new e,o=setInterval(function(){g()&&p()},100),r=!1,m()}(),{sampleLoad:function(e){let t={name:e,id:sgx.audio.Engine.get().registerGlobalSound(e)};return f.push(t),t},samplePlay:function(e){e&&e.id&&sgx.audio.Engine.get().playSound(e.id)},tonePlay:function(e,t){let n=b(e);setTimeout(()=>{y(n)},1e3*t)},toneStart:b,toneStop:y,rtStart:function(){c=!0,p()},rtApplyDAC1bit:function(e){if(!g()&&!r)for(let t=0;t<e.length;++t){let n=e[t]?255:0;for(let e=0;e<u;++e)i.push(n)}},rtApplyDAC8bit:function(e){if(!g()&&!r)for(let t=0;t<e.length;++t)for(let n=0;n<u;++n)i.push(e[t])},rtFillDurationDAC1bit:function(e,t){if(g()||r)return;let n=e*a*u,s=t?255:0;e>1&&(n=1e3/60);for(let e=0;e<n;++e)i.push(s)},reset:m,muteAll:function(){r=!0,i=new Array,h(),v()},unmuteAll:function(){r=!1}}},emf.assembler=function(e){return{assemble:function(t,n=0){let r,i,s,o={blocks:[],errorList:[],fullMap:[]};e.assemble.start(),e.assemble.clearEquateMap();for(let a=0;a<2;++a){let u=n;(s=[]).push({start:n,data:[]}),i=!0;let c=-1;t.forEach(n=>{++c;let i,f=n.lastIndexOf(";");-1!==f&&(i=n.substr(f+1),n=n.substr(0,f-1)),null!=(r=n.match(/([^\s]+):(.*)/i))&&(e.assemble.setEquateValue(r[1],u),n=r[2]),null!=(r=n.match(/([^\s]+)\s+equ\s+(.*)/i))&&(e.assemble.setEquateValue(r[1],emf.utils.convertToDecimal(r[2])),n=""),null!=(r=n.match(/org\s+(.*)/i))&&(n="",u=emf.utils.convertToDecimal(r[1]),s.push({start:u,data:[]}));let l={};if(null!=(r=n.match(/dc.b\s+(.*)/i))){let e=r[1].split(",");l.data=e.map(e=>emf.utils.convertToDecimal(e)),l.errorList=[]}else null!=(r=n.match(/^\s*$/i))||(l=e.assemble.assemble(n),1===a&&(l||(o.errorList=o.errorList.concat({lineIdx:c,text:"Unknown opcode or format"})),l&&l.errorList&&(o.errorList=o.errorList.concat({lineIdx:c,text:l.errorList}))));l&&l.data&&(1===a&&(o.fullMap.push({address:u,data:l.data,asm:t[c]}),s[s.length-1].data=s[s.length-1].data.concat(l.data)),u+=l.data.length)})}o.blocks=s.filter(e=>0!==e.data.length),o.success=0===o.errorList.length,o.equmap=e.assemble.getEquateMap();let a=new emf.memory;return o.memory=a.create(),o.blocks.forEach(e=>{o.memory.addBlockFromData(e.start,e.data)}),o},showFullMap:function(e,t){let n="";t.forEach(e=>{n+=emf.utils.padRight(emf.utils.hex16(e.address),6),n+=emf.utils.padRight(e.data.map(e=>emf.utils.hex8(e)).join(" "),16),n+=emf.utils.padRight(e.asm),n+="<br>"}),n=n.replace(/\s/g,"&nbsp;"),$(e).html(n)},showErrorList:function(e,t){let n="";t.forEach(e=>{n+=emf.utils.padRight(e.lineIdx,6)+" : ",n+=emf.utils.padRight(e.text),n+="<br>"}),n=n.replace(/\s/g,"&nbsp;"),$(e).html(n)},showEquTable:function(e,t){let n="";Object.keys(t).forEach(e=>{n+=emf.utils.padRight(e,16),n+=emf.utils.padRight(t[e]),n+="<br>"}),n=n.replace(/\s/g,"&nbsp;"),$(e).html(n)}}},emf.bus=function(e){let t={},n={},r=this;function i(e){return t[e]||(t[e]={state:!1,listen:[]}),t[e]}function s(e){return n[e]||(n[e]={data:0}),n[e]}function o(e){let t=i(e);!1===t.state&&(t.state=!0,u(t.listen,"onRising"))}function a(e){let t=i(e);!0===t.state&&(t.state=!1,u(t.listen,"onFalling"))}function u(e,t){e.forEach(e=>{e[t]&&e[t]()})}return(e=e||{}).reset=e.reset||function(){},{reset:function(){e.reset(r)},attachPin:function(e,t){i(e).listen.push(t)},readPinState:function(e){return i(e).state},readBlock:function(e){return s(e).data},writeBlock:function(e,t){s(e).data=t},setHigh:o,setLow:a,pulseLow:function(e){a(e),o(e)},pulseHigh:function(e){o(e),a(e)}}},emf.comparator=function(e){let t=!0;function n(e,t,n,r){void 0!==n&&void 0!==r&&(e.differences[t]=e.differences[t]||{},n==r?(e.differences[t].different=!1,e.differences[t].reported=!1):e.differences[t].v1===n&&e.differences[t].v2===r||(e.differences[t].v1=n,e.differences[t].v2=r,e.differences[t].different||(e.differences[t].reported=!1,e.changes|=!0),e.differences[t].different=!0))}return(e=e||{}).checkRegisters=void 0===e.checkRegisters||e.checkRegisters,e.checkFlags=void 0===e.checkFlags||e.checkFlags,e.checkMemory=void 0===e.checkMemory||e.checkMemory,{enable:function(){t=!0},disable:function(){t=!1},compare:function(r,i,s,o){if(!t)return!0;(o=function(e){return(e=e||{}).differences=e.differences||{},e}(o)).pc=r,o.m1=i,o.m2=s,o.changes=!1;let a=i.bus.cpu.emulate.getState(),u=s.bus.cpu.emulate.getState(),c=a.registers,f=u.registers;e.checkRegisters&&Object.keys(f).forEach(function(e){let t=c[e],r=f[e];void 0!==t&&void 0!==r&&n(o,`cpu_reg_${e}`,t.getUnsigned(),r.getUnsigned())});let l=a.flags,d=u.flags;return e.checkFlags&&Object.keys(d).forEach(function(e){let t=l[e],r=d[e];void 0!==t&&void 0!==r&&n(o,`cpu_flg_${e}`,t,r)}),o.changes},report:function(e){Object.keys(e.differences).forEach(t=>{let n=e.differences[t];if(n.different&&!n.reported){let r=e.m1.bus.cpu.disassemble.disassemble(e.m1.bus,e.pc),i=`PC: ${emf.utils.hex16(e.pc)} : ${r.instruction}`;i+=` : ${t} => ${n.v1}  !=  ${n.v2} `,console.log(i),n.reported=!0}})}}},emf.controller=function(e,t){let n,r={},i=60,s=[],o={},a={},u=[];function c(){f()}function f(){e.reset(),u.forEach(e=>{e.machine.reset()})}function l(n){d(),n=Math.min(n||20,i),r.lastTime=Date.now(),r.interval=setInterval(()=>{p({state:r})},1e3/n),m("start"),t.onStart(e)}function d(){clearInterval(r.interval),r.interval=void 0,m("stop"),t.onStop(e)}function m(e){o[e]&&o[e].forEach(e=>{e()})}function g(){return!!r.interval}function p(r){let i,o,a=Date.now(),c=0,f=0,l=e.clock.cpu.getFrequency(),m=1/l;if(r.state){let e=(a-r.state.lastTime)/1e3;o=l*(e=Math.min(e,.1))}else o=100*r.steps,f=r.steps;i=0;do{let t;y(),u.forEach(e=>{t=e.machine.update({steps:1})});let r=e.bus.cpu.emulate.getRegisterValuePC();i+=(t=e.update({steps:1})).cpu,++c;let o=m*t.cpu;Object.keys(e.bus.clock).forEach(t=>{e.bus.clock[t].tick(o)}),u.forEach(t=>{t.comparator.compare(r,e,t.machine)||d()});let a=e.bus.cpu.emulate.getRegisterValuePC();n===a?d():-1!==s.indexOf(a)&&d()}while((i<o||f&&c<f)&&g());r.state&&(r.state.lastTime=a),t.onUpdate(e),u.forEach(e=>{t.onUpdate(e.machine)})}function h(e){a.isTracing=!0,a.options=e||{}}function b(){a.isTracing=!1}function y(){if(!a.isTracing&&void 0===a.startAt)return;let t=e.device.cpu.emulate.getRegisterValuePC();if(a.isTracing){let n=e.device.cpu.emulate.getState();if(Object.keys(n.registers).forEach(e=>{n.registers[e]=n.registers[e].getUnsigned()}),a.options.traceIf&&a.options.traceIf(n))return;a.options.traceFilter&&a.options.traceFilter(n),a.options.traceOutput?a.options.traceOutput(n):console.log(JSON.stringify(n)),t===a.endAt&&b()}else t===a.startAt&&h(a.options)}return(t=t||{}).onStart=t.onStart||function(e){},t.onStop=t.onStop||function(e){},t.onUpdate=t.onUpdate||function(e){},{coldStart:c,coldLoadData:function(n,r,i){i=i||{};let s=g();d(),c();let o=0;i.startAddress&&(o=i.startAddress),(new emf.importer).byFilename(n,e,o,r),i.patch&&i.patch(e,i),t.onUpdate(e),s&&l()},reset:f,startRunning:l,stopRunning:d,isRunning:g,step:function(e){return d(),p({steps:e=e||1}),0},addBreakpointAt:function(e){-1===s.indexOf(e)&&s.push(e)},clearBreakpointAt:function(e){let t=s.indexOf(e);-1!==t&&s.slice(t)},clearBreakpointList:function(){s=[]},getBreakpointList:function(){return s},runUntil:function(e){n=e},clearComparisonMachine:function(){u=[]},addComparisonMachine:function(e,t){u.push({machine:e,comparator:t})},traceBetween:function(e,t,n){a.startAt=e,a.endAt=t,a.isTracing=!1,a.options=n||{}},traceStart:h,traceEnd:b,on:function(e,t){o[e]=o[e]||[],o[e].push(t)}}},emf.debugemf=function(e,t,n){let r=[],i=[],s={bp:function(n){let r,i,s=n[2];switch(e.bus[s]?(s=e.bus[s].emulate,i=n[3],r=emf.utils.convertStringToDecimal(i)):(s=e.bus.cpu.emulate,i=n[2],r=emf.utils.convertStringToDecimal(i)),n[1]){case"list":let o=t.getBreakpointList();return[o.length?o:"No breakpoints set."];case"clear":return t.clearBreakpointList(),["Breakpoints cleared"];case"add":return t.addBreakpointAt(r),[`Set to ${i} ${i==r?"":"== ".address}`];default:return[`Unknown bp command '${n[1]}'`]}},set:function(t){let r=t[1],i=emf.utils.convertStringToDecimal(t[2]);if("flag"===r){let n=t[2];i=emf.utils.convertStringToDecimal(t[3]),e.bus.cpu.emulate.setFlagValue(n,i)}else e.bus.cpu.emulate.setRegisterValue(r,i);return n.getCPUStateAsArray()},mem:function(t){let n=emf.utils.convertStringToDecimal(t[2]),r=emf.utils.convertStringToDecimal(t[3]);if(void 0===n)return[`Invalid address: ${t[2]}`];switch(t[1]){case"dump":let i=`0x${emf.utils.hex16(n)} : `;for(let t=0;t<(r||8);++t)r=e.bus.memory.read8(n+t),i+=emf.utils.hex8(r)+" ";return[i];case"read8":return r=e.bus.memory.read8(n),[`0x${emf.utils.hex16(n)} : 0x${emf.utils.hex8(r)}  (%${emf.utils.bin8(r)} ${r})`];case"read16":return r=e.bus.memory.read16(n),[`0x${emf.utils.hex16(n)} : 0x${emf.utils.hex16(r)}  (%${emf.utils.bin16(r)} ${r})`];case"write8":return e.bus.memory.write8(n,r),[`0x${emf.utils.hex16(n)} : 0x${emf.utils.hex8(r)}  (%${emf.utils.bin8(r)} ${r})`];case"write16":return e.bus.memory.read16(write16,r),[`0x${emf.utils.hex16(n)} : 0x${emf.utils.hex16(r)}  (%${emf.utils.bin16(r)} ${r})`];default:return[`Unknown mem command '${t[1]}'`]}},run:function(){return t.startRunning(),["Running"]},start:function(){return t.startRunning(),["Running"]},stop:function(){return t.stopRunning(),["Stopped"]},step:function(){return t.step(),n.getCPUStateAsArray()},list:function(t){let r=e.bus.cpu,i=t.length<2?r.emulate.getRegisterValuePC():emf.utils.convertStringToDecimal(t[1]),s=emf.utils.convertStringToDecimal(t[2])||5,o=[];for(;s>0;--s){let e=n.disassembleLinePlain(r,i,i);o.push(e.span),i+=e.dis.byte_length}return o},trace:function(e){let n=e.length>1?e[1].toLowerCase():"",r=`Unknown command: '${n}'. Options: start, stop, between`;if("start"===n)t.traceStart(),r="Started";else if("stop"===n)t.traceEnd(),r="Stopped";else if("between"===n){let n=emf.utils.convertStringToDecimal(e[2]),i=emf.utils.convertStringToDecimal(e[3]);t.traceBetween(n,i),r=`Tracing between ${n} and ${i}`}return[r]},peek:function(t){let n=emf.utils.convertStringToDecimal(t[1]);return data=e.bus.memory.read8(n),[`0x${emf.utils.hex16(n)} : 0x${emf.utils.hex8(data)}  (%${emf.utils.bin8(data)} ${data})`]},poke:function(t){let n=emf.utils.convertStringToDecimal(t[1]),r=emf.utils.convertStringToDecimal(t[2]);return e.bus.memory.write8(n,r),[`0x${emf.utils.hex16(n)} : 0x${emf.utils.hex8(r)}  (%${emf.utils.bin8(r)} ${r})`]},inject:function(e){let t=e[1];switch(t){case emf.input.ACTION_KEYDOWN:case emf.input.ACTION_KEYUP:emf.input.inject(t,e[2])}return["OK"]}};return{addCommand:function(e,t,n){i.push({cmd:e,info:t,cbfn:n})},executeCommand:function(e){if("help"===e||"?"===e)return["bp list ; list all breakpoints","bp add <address> ; add new breakpoint","bp clear <address> ; clear breakpoint","mem write8 <address> <data>","mem write16 <address> <data>","mem read8 <address>","mem read16 <address>","set <registername> <value>","set flag <flagname> <value>","start ; also, run","stop","step","trace <start|stop|between> ; write every CPU step to console.log","list [start_address] [rows] ; show disassembly, start_address defaults to PC","inject <keydown|keyup> <keyname|ascii>","peek <address> ; synonym for read8","poke <address> <data> ; synonym for write8"];r.unshift(e),r.splice(100);let t=e.split(/\s+/);if(t.length<1)return[];if(s[t[0]])return s[t[0]](t);{let e=void 0;if(i.forEach(n=>{n.cmd===t[0]&&(e=n.cbfn(t))}),e)return e}return["Unknown command"]},getHistory:function(e){return(e=e||1)>r.length?"":r[e-1]}}},emf.device=emf.device||{},emf.device.PaperTape=function(e){let t,n;function r(){s()}function i(e){t=e,r()}function s(){o(0)}function o(e){n=e<0?0:e>=t.length?t.length-1:e}function a(e){if(void 0===t)return{error:"No tape loaded"};let r=t[void 0===e?n:e];return void 0===r?{error:"Tape index is invalid"}:{data:r,is_eof:e>=t.length,duration:1}}return function(e){i(e)}(e),{reset:r,loadTape:i,rewind:s,seekTo:o,seekForward:function(e){o(n+e)},seekBackward:function(e){o(n-e)},getPointer:function(){return n},peek:a,fetch:function(){let e=a();return void 0===e.error&&++n,e},getWidth:function(){return 2}}},emf.device=emf.device||{},emf.device.Teleprinter=function(e){let t;function n(){$(t).html("")}return function(e){t=e,n()}(e),{reset:n,onCharacterRead:function(){return 0},onCharacterPrint:function(e){$(t).append(e)},onLinePrint:function(e){$(t).append(e),$(t).append("<br>")}}},emf.dragDrop=function(e,t,n){function r(e){e.stopPropagation(),e.preventDefault();let t=e.dataTransfer.files;for(let e,r=0;e=t[r];r++){let t=new FileReader;t.onload=function(t){t.target.readyState==FileReader.DONE&&n&&n(e.name,new Uint8Array(t.target.result))},t.readAsArrayBuffer(e);break}}function i(e){e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy"}return function(){let t=document.getElementById(e);t.addEventListener("dragover",i,!1),t.addEventListener("drop",r,!1)}(),{}},emf.eaas={},emf.eaas.root="http://em.ulat.es/archive/",emf.eaas.getResourceURL=function(e){return`${emf.eaas.root}/get.php?id=${e}`},emf.eaas.getResourceMetadataURL=function(e){return`${emf.eaas.root}/get.php?meta=${e}`},emf.exporter=function(){function e(e,t){(t=t||{}).maxLineLengthInCharacters=64;let n={};return n.format="intel.hex.json:1",n.rows=[],e.getAddressRanges().forEach(r=>{r.shadow||function(r,i){let s=r,o="";function a(e){n.rows.push({address:s,size:o.length/2,data:o}),o="",s=e}for(let n=r;n<i;++n){let r=e.read8(n,!0);(o+=r?emf.utils.hex(r,2):"00").length>=t.maxLineLengthInCharacters&&a(n+1)}o&&a()}(r.start,r.start+r.size)}),n}return{emfMachine:function(e,t){let n={};t=t||{};for(let t in e.device){let r=e.device[t].getState;r&&e.device.hasOwnProperty(t)&&(n[t]={format:"emf.state.json:1",state:r()})}return n},emfMemory:function(t,n){return e(t,n)},emfNameValue:function(e,t){t=t||{};let n={format:"emf.namevalue.json:1",state:{}};return Object.keys(e).forEach(function(t){n.state[t]=e[t].getUnsigned?e[t].getUnsigned():e[t]}),n},intelHEX:function(e,t){let n={format:"intel.hex.json:1",rows:[]};return e.getAddressRanges().forEach(t=>{t.shadow||function(t,r){let i=t,s="";function o(e){let t=s.length/2,r=emf.utils.hex(t,2);r+=emf.utils.hex(i,4),r+=emf.utils.hex(0,2);let o=0;for(let e=0;e<t;++e)o+=parseInt(s.substr(2*e,2),16);o=255&-(o&=255),o=emf.utils.hex(o,2),s=":"+r+s+o,n.rows.push(s),s="",i=e}for(let n=t;n<r;++n){let t=e.read8(n,!0);(s+=t?emf.utils.hex(t,2):"00").length>=32&&o(n+1)}s&&o()}(t.start,t.start+t.size)}),n.rows.push(":00000001FF"),n},intelHEXJSON:e}},emf.framework=function(e){function t(t,n,r){let i=t.disassemble.disassemble(n),s="";s+=r==n?"<span class='emf_disassembly_line current'>":"<span class='emf_disassembly_line'>",s+=emf.utils.hex16(n)+" : ";let o="";for(let t=0;t<i.byte_length;++t)e.bus.memory.isValidAddress(n+t)?o+=emf.utils.hex(e.bus.memory.read8(n+t),2)+" ":o+="xx ";e.options.disassemble.widthColumnHex&&(s+=emf.utils.toMarkup(emf.utils.pad(o,e.options.disassemble.widthColumnHex))),s+=emf.utils.toMarkup(emf.utils.pad(i.instruction,e.options.disassemble.widthColumnInstruction)),i.comment&&(s+="; "+emf.utils.toMarkup(i.comment));let a=e.bus.memory.getLabel(n);return a&&(s+="; "+a),{span:s+="</span><br>",dis:i}}function n(t,n,r,i=null){let s="",o=8,a=!1;e.options.framework&&e.options.framework.memoryView&&(o=e.options.framework.memoryView.width||o,a=e.options.framework.memoryView.showASCII);for(let e=n;e<r;e+=o){let n=emf.utils.hex16(e)+" : ",r="emf_memory_line";for(let s=0;s<o;++s){let o;t.isValidAddress(e+s)&&(o=t.read8(e+s)),void 0!==o?(i&&t.read8(e+s)!=o&&(r+=" changed"),o=emf.utils.hex(o,2)):o="xx",n+=o+" "}if(a){n+=" : ";for(let r=0;r<o;++r)if(t.isValidAddress(e+r)){let i=t.read8(e+r),s=sgxToCharacter(i);n+=sgxIsPrint(s)&&i>31&&i<128?"&#"+i+";":"?"}else n+="?"}s+=n+"<br>"}return s}return{getCPUStateAsArray:function(){let t=[],n=e.bus.cpu.emulate.getState();t.push("Registers:");let r=n.registers;Object.keys(r).forEach(function(e){let n=r[e];t.push(`${e} : 0x${emf.utils.hex(n.getUnsigned(),sgxRoundUp(n.getBitWidth()/4))}`)}),t.push(""),t.push("Flags:");let i=n.flags,s="";return Object.keys(i).forEach(function(e){let t=i[e];s+=`  ${e} : ${t?"1":"0"}`}),t.push(s),t},createMemoryDisplay:function(t){t=t||{};let n=$(t.divTab),r=e.bus.memory.getAddressRanges(),i=" active",s="emf_memory_";r.forEach(e=>{let t='<li class="nav-item">';t+=`<a class="nav-link ${i}" id="${s}${e.name}-tab" data-toggle="tab" href="#${s}${e.name}" role="tab" aria-controls="${s}${e.name}" aria-selected="true">${e.name.toUpperCase()}</a>`,t+="</li>",n.append(t),i=""});let o=$(t.divContentsTab);i=" active",r.forEach(e=>{let t=`<div class="tab-pane fade show ${i}" id="${s}${e.name}" role="tabpanel" aria-labelledby="${s}${e.name}-tab">`;t+=`<div class="card scrollable" id="${s}${e.name}_content"></div>`,t+="</div>",o.append(t),i=""})},registers:function(e,t,n){const r=t.emulate.getState();let i=r.registers,s="",o=0;Object.keys(i).forEach(function(e){0==o&&(s+='<div class="row">');let t=i[e],r="emf_register";n&&n.registers[e].get()!=t.get()&&(r+=" changed"),s+='<div class="col-sm-4">',s+=`<span class='${r}'>`,s+=`${e}:0x${emf.utils.hex(t.getUnsigned(),sgxRoundUp(t.getBitWidth()/4))}`,s+="</span></div>",3==++o&&(s+="</div>",o=0)}),0==o&&(s+="</div>");let a=r.flags;Object.keys(a).forEach(function(e){let t=a[e],r="emf_register";n&&n.flags[e]!=t&&(r+=" changed"),s+=`<span class='${r}'>`,s+=`${e}:${t?"1":"0"}&nbsp;&nbsp;`,s+="</span>"}),$(e).html(s)},disassembleRows:function(e,n,r,i,s){let o="",a=0;for(let e=r;a<i;++a){let r=t(n,e,s);o+=r.span,e+=r.dis.byte_length}$(e).html(o)},disassembleLinePlain:function(t,n,r){let i=t.disassemble.disassemble(n),s="";s+=emf.utils.hex16(n)+" : ";let o="";for(let t=0;t<i.byte_length;++t)e.bus.memory.isValidAddress(n+t)?o+=emf.utils.hex(e.bus.memory.read8(n+t),2)+" ":o+="xx ";e.options.disassemble.widthColumnHex&&(s+=emf.utils.pad(o,e.options.disassemble.widthColumnHex)),s+=emf.utils.pad(i.instruction,e.options.disassemble.widthColumnInstruction),i.comment&&(s+="; "+emf.utils.toMarkup(i.comment));let a=e.bus.memory.getLabel(n);return a&&(s+="; "+a),{span:s,dis:i}},disassembleLine:t,disassembleRange:function(e,n,r,i,s){let o="";for(let e=r;e<i;){let r=t(n,e,-1);o+=r.span,e+=r.dis.byte_length}$(e).html(o)},populateMemoryDisplay:function(t){e.bus.memory.getAddressRanges().forEach(n=>{let r=`#emf_memory_${n.name}_content`;if(n.shadow)$(r).html("Shadow");else if(n.enabled){if(t);else if(!n.write)return;gStateVars.framework.memory(r,e.bus.memory,n.start,n.start+n.size)}else $(r).html("Disabled")})},memory:function(e,t,r,i,s){if(void 0===r){let r="";return t.getAddressRanges().forEach(e=>{r+=n(t,e.start,e.start+e.size,s)}),void $(e).html(r)}let o=n(t,r,i,s);$(e).html(o)},paperTape:function(e,t){let n="",r=0,i=t.getPointer(),s=t.getWidth();do{let e=t.peek(r),o="emf_tape_entry";if(e.error)break;r==i&&(o+=" current"),n+="<span class='"+o+"'>"+emf.utils.hex(e.data,s)+"</span> ",++r}while(!rt.is_eof);$(e).html(n)}}},emf.importer=function(){let e={emf:r,json:r,hex:s,ihj:i,hxs:o,bin:a};function t(e){return e instanceof Uint8Array?function(e){return("string"==typeof e?e:new TextDecoder("utf-8").decode(e)).split("\n")}(e):"string"==typeof e?e.split("\n"):e}function n(e){let t=e.split(":");return{format:t[0]||"unknown",version:parseInt(t[1])||0}}function r(e,t){let r="string"==typeof t?t:new TextDecoder("utf-8").decode(t),i=JSON.parse(r);for(let t in e.device)e.device.hasOwnProperty(t)&&(i[t]?e.device[t].setState?"emf.state.json"!==n(i[t].format).format?console.error(`The '${t}' state block is not in a valid format.`):e.device[t].setState(i[t].state):console.error(`No way of loading the state for '${t}' because the 'setState' method doesnt exist.`):console.log(`No '${t}' to import.`));return!0}function i(e,t){let n=e.read8?e:e.bus.memory;t.rows.forEach(e=>{for(let t=0;t<e.size;++t){let r=parseInt(e.data.substr(2*t,2),16);n.write8(e.address+t,r,!0)}})}function s(e,n){let r=e.read8?e:e.bus.memory;(n=t(n)).forEach(e=>{if(":"!==e[0])return;let t=parseInt(e.substr(1,2),16),n=parseInt(e.substr(3,4),16),i=parseInt(e.substr(7,2),16);switch(i){case 0:let s=0;for(let t=0;t<4;++t){s+=parseInt(e.substr(1+2*t,2),16)}for(let i=0;i<t;++i){let t=parseInt(e.substr(9+2*i,2),16);s+=t,r.write8(n+i,t,!0)}s=255&-(s&=255),parseInt(e.substr(9+2*t,2),16)!=s&&console.log(`EMF.importer.intelHEX : Error in checksum in row ${e}`);break;case 1:break;default:console.log(`EMF.importer.intelHEX : Error with supported record type ${i}`)}})}function o(e,t,n){let r=e.read8?e:e.bus.memory;t=(t=t.replace(/0x/gi,"")).replace(/\s/g,"");for(let e=0;e<t.length;e+=2){let i=parseInt(t.substr(e,2),16);r.write8(n+e/2,i,!0)}}function a(e,t,n){let r=e.read8?e:e.bus.memory;for(let e=0;e<t.length;++e)r.write8(n+e,t[e],!0)}return{byFilename:function(t,n,r,i){let s=t.lastIndexOf(".");return-1===s?a(i,r):(s=(s=t.substr(s+1)).toLowerCase(),e[s]?(e[s]!==a&&(i=function(e){let t="";return e.forEach(e=>{t+=String.fromCharCode(e)}),t}(i)),e[s](n,i,r)):a(n,i,r))},byURL:function(e){return new Promise(function(t,n){fetch(e).then(function(e){return e.blob()}).then(function(e){return e.arrayBuffer()}).then(function(e){return new Uint8Array(e)}).then(function(e){t(e)}).catch(function(e){n(e)})})},intelHEX:s,intelHEXJSON:i,hexString:o,raw:a,emfState:r}},emf.input={},emf.input.ACTION_KEYDOWN="keydown",emf.input.ACTION_KEYUP="keyup";let listenerList={keyDown:[],keyUp:[]},keyStateList=[],supportAutoRepeat=!1;!function(){function e(e){"text"!==document.activeElement.type&&"textarea"!==document.activeElement.type&&(t(e.type,e.keyCode),[32,37,38,39,40].indexOf(e.keyCode)>-1&&e.preventDefault())}function t(e,t){const n="keydown"===e,r="keydown"===e?listenerList.keyDown:listenerList.keyUp;keyStateList[t]&&n&&!supportAutoRepeat||(keyStateList[t]=!!n,r.forEach(e=>{e(t)}))}document.addEventListener("keydown",function(t){e(t)}),document.addEventListener("keyup",function(t){e(t)}),emf.input.injectCursorUp=function(e){emf.input.inject(e,"up")},emf.input.injectCursorDown=function(e){emf.input.inject(e,"down")},emf.input.injectCursorLeft=function(e){emf.input.inject(e,"left")},emf.input.injectCursorDown=function(e){emf.input.inject(e,"right")},emf.input.inject=function(e,n){let r={up:38,down:40,left:37,right:39,return:13,enter:13,delete:8};switch(void 0!==r[n]?n=r[n]:"number"==typeof n||(n=sgxASCII(n)),e){case emf.input.ACTION_KEYDOWN:return t("keydown",n);case emf.input.ACTION_KEYUP:return t("keyup",n)}}}(),emf.input.onKeyDown=function(e){listenerList.keyDown.push(e)},emf.input.onKeyUp=function(e){listenerList.keyUp.push(e)},emf.input.setAutoRepeat=function(e){supportAutoRepeat=e},emf.Maths=emf.Maths||{},emf.Maths.add_u8u8=function(e,t,n=0){return(e=e.get?e.getUnsigned():e)+(t=t.get?t.getUnsigned():t)+n&255},emf.Maths.add_u8s8=function(e,t,n=0){return(e=e.get?e.getUnsigned():e)+(128&(t=t.get?t.getUnsigned():t)?t-256:t)+n&255},emf.Maths.eq8=function(e,t){return(e=e.get?e.getUnsigned():e)===(t=t.get?t.getUnsigned():t)},emf.Maths.neq8=function(e,t){return(e=e.get?e.getUnsigned():e)!==(t=t.get?t.getUnsigned():t)},emf.Maths.bit8or=function(e,t){return(e=e.get?e.getUnsigned():e)|(t=t.get?t.getUnsigned():t)},emf.Maths.bit8and=function(e,t){return(e=e.get?e.getUnsigned():e)&(t=t.get?t.getUnsigned():t)},emf.Maths.bit8xor=function(e,t){return(e=e.get?e.getUnsigned():e)^(t=t.get?t.getUnsigned():t)},emf.Maths.add_u16u8=function(e,t,n=0){return(e=e.get?e.getUnsigned():e)+(t=t.get?t.getUnsigned():t)+n&65535},emf.Maths.add_u16u16=function(e,t,n=0){return(e=e.get?e.getUnsigned():e)+(t=t.get?t.getUnsigned():t)+n&65535},emf.Maths.add_u16s16=function(e,t,n=0){return(e=e.get?e.getUnsigned():e)+(32768&(t=t.get?t.getUnsigned():t)?t-65536:t)+n&65535},emf.Maths.add_u16s8=function(e,t,n=0){return(e=e.get?e.getUnsigned():e)+(128&(t=t.get?t.getUnsigned():t)?t-256:t)+n&65535},emf.Maths.sub_u16u16=function(e,t){return(e=e.get?e.getUnsigned():e)-(t=t.get?t.getUnsigned():t)&65535},emf.Maths.eq16=function(e,t){return(e=e.get?e.getUnsigned():e)===(t=t.get?t.getUnsigned():t)},emf.Maths.neq16=function(e,t){return(e=e.get?e.getUnsigned():e)!==(t=t.get?t.getUnsigned():t)},emf.Maths.random=function(e){return Math.floor(65535*Math.random())&e},emf.Maths.random16=function(e){return Math.floor(65535*Math.random())&e},emf.memory=function(){function e(e,t){t=t||1024;let n=new Array(t);return{name:"block",start:e||0,size:t,read:!0,write:!0,shadow:!1,enabled:!0,read8:function(t){return n[t-e]},write8:function(t,r){n[t-e]=r}}}function t(t,n){let r=new function(){let t=[];return{addBlock:function(n,r){let i=new e(n,r);t.push(i)},addBlockFromData:function(n,r){let i=new e(n,r.length);for(let e=0;e<r.length;++e)i.write8(n+e,r[e]);t.push(i)},isValidAddress:function(e){let n=!1;return t.forEach(t=>{e>=t.start&&e<t.start+t.size&&(n=!0)}),n},getAddressRanges:function(){return t},read8:function(e){let n=void 0;return t.forEach(t=>{e>=t.start&&e<t.start+t.size&&(n=t.read8(e))}),n},write8:function(e,n){t.forEach(t=>{e>=t.start&&e<t.start+t.size&&t.write8(e,n)})}}};return void 0!==t&&r.addBlock(t,n),r}return{create:t,createFromArray:function(e,n){let r=t(e,n.length);return r.addBlockFromData(e,n),r}}},emf.Number=function(e,t,n){let r,i,s,o,a,u,c;function f(e){if("number"==typeof e);else if(void 0===e);else if(e.hasOwnProperty("get"))return e.get();return e}function l(e){return(r=f(e))<0&&(r+=a+1),r&=a,this}function d(e){var t=f(e);return g((r+=f(t))>=a),r&=a,this}function m(){return r&o?c+(r&u):r&u}function g(e){return flagV=e,this}function p(){return flagV}return function(e,t,n){e&&e.hasOwnProperty("get")&&(t=e.getComplement(),n=e.getUnsigned(),e=e.getBitWidth()),s=e||8,i=t||2,a=(1<<s)-1,u=(1<<s-1)-1,c=-(o=1<<s-1),l(n)}(e,t,n),{assign:l,add:d,adc:function(e,t){var n=!1;return d(e),n|=p(),d(f(t)?1:0),n|=p(),flagV=n,this},sub:function(e){return l(r-f(e)),this},neg:function(){return l(1+~r),this},notEquals:function(e){return f(e)!==m()},equals:function(e){return f(e)===m()},get:m,getUnsigned:function(){return r},getBitWidth:function(){return s},bitAnd:function(e){return r&=f(e),this},bitOr:function(e){return r|=f(e),this},shiftLogicalLeft:function(e){for(var t=0;t<e;++t)r&o>>1&&(r|=o),r<<=1;l(r)},shiftLogicalRight:function(e){for(var t=0;t<e;++t)g(1&e),r>>=1;l(r)},getComplement:function(){return i},getMasked:function(e,t){var n=r>>t;return n&=emf.Number.maskLSB(e-t)},isNegative:function(){return!!(r&o)},isOverflow:p}},emf.Number.maskLSB=function(e){return(1<<e)-1},emf.Number.maskMSB=function(e,t){return(1<<e)-1<<t-e},emf.Number.getUnsigned=function(e){return typeof e===emf.Number?e.getUnsigned():e},emf.Number.prototype.toString=function(){return value},emf.saveAs=function(){return{saveAs:function(e,t){let n=JSON.stringify(t,null,2),r=document.createElement("a");r.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(n)),r.setAttribute("download",e),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}}},emf.scripting={},emf.scripting.createEventList=function(){let e=[];return{addEvent:function(t,n){e.push({condition:{at:t},action:n})},clearList:function(){e=[]},runList:function(e,t){return new Promise(function(e,t){e()})},stopList:function(){return new Promise(function(e,t){e()})}}},emf.ui={},emf.ui.CURSOR_WAIT="wait",emf.ui.CURSOR_ARROW="auto",emf.ui.setCursor=function(e){document.body.style.cursor=e},emf.utils={},emf.utils.pad=function(e,t){let n=e;return void 0!==t&&(n=(n+=" ".repeat(t)).substr(0,t)),n},emf.utils.padRight=function(e,t){return emf.utils.pad(e,t)},emf.utils.padLeft=function(e,t){return emf.utils.pad(e,t)},emf.utils.toMarkup=function(e){return e.replace(/ /g,"&nbsp;")},emf.utils.hex=function(e,t){return emf.utils.convertIntegerToBase(e,16,t)},emf.utils.hex8=function(e){return e&=255,emf.utils.convertIntegerToBase(e,16,2)},emf.utils.hex16=function(e){return e&=65535,emf.utils.convertIntegerToBase(e,16,4)},emf.utils.bin=function(e,t){return emf.utils.convertIntegerToBase(e,2,t)},emf.utils.bin8=function(e){return e&=255,emf.utils.convertIntegerToBase(e,2,8)},emf.utils.bin16=function(e){return e&=65535,emf.utils.convertIntegerToBase(e,2,16)},emf.utils.convertToDecimal=function(e){return emf.utils.convertStringToDecimal(e)},emf.utils.convertBinarytoDecimal=function(e){return emf.utils.convertStringToDecimal(e,2)},emf.utils.convertHexToDec=function(e){return emf.utils.convertStringToDecimal(e,16)},emf.utils.convertDecToHex=function(e){return(e&=0x10000000000000000).toString(16)},emf.utils.convertHexStringtoArray=function(e){if(e.length%2==1)throw new Exception;for(var t=[],n=0;n<e.length;n+=2){var r=16*parseInt(e[n],16);r+=parseInt(e[n+1],16),t.push(r)}return t},emf.utils.convertStringToDecimal=function(e,t=10){if(void 0===e)return;let n=e.replace(/\s/g,"");"%"===n.substr(0,1)?(n=n.substr(1),t=2):"0x"===n.substr(0,2)||"0X"===n.substr(0,2)?(n=n.substr(2),t=16):"0"===n.substr(0,1)?t=t||8:"$"===n.substr(0,1)?(n=n.substr(1),t=16):"h"!==n.substr(-1)&&"H"!==n.substr(-1)||(n=n.substr(0,n.length-1),t=16);let r=parseInt(n,t);return isNaN(r)?void 0:r},emf.utils.convertIntegerToBase=function(e,t,n){let r=e.toString(t);if(void 0!==n){r=(r="0".repeat(n)+r).substr(r.length-n)}return r};